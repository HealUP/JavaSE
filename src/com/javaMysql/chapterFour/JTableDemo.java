package com.javaMysql.chapterFour;

import com.javaMysql.chapterTwo.DBUtil;

import java.awt.BorderLayout;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.sql.ResultSet;
import java.sql.ResultSetMetaData;
import java.util.Vector;

import javax.swing.JButton;
import javax.swing.JFrame;
import javax.swing.JOptionPane;
import javax.swing.JPanel;
import javax.swing.JScrollPane;
import javax.swing.JTable;
import javax.swing.ListSelectionModel;
import javax.swing.table.DefaultTableModel;



public class JTableDemo extends JFrame {
	// ???????????
	private JScrollPane spTable;
	// ?????????????????
	private JPanel pButtons;
	private JButton bthDelete, btnFlush;
	// ???????????
	private DefaultTableModel model;
	// ???????
	private JTable table;

	public JTableDemo() {
		super("?????");

		// ???????????
		model = new DefaultTableModel();
		// ???????
		table = new JTable(model);
		// ??????????????????
		table.setSelectionMode(ListSelectionModel.SINGLE_SELECTION);

		// ?????????????ÈÉ???????
		spTable = new JScrollPane(table);
		// ?????????????????????
		this.add(spTable, BorderLayout.CENTER);

		// ???????
		bthDelete = new JButton("???");
		btnFlush = new JButton("???");
		// ???????
		pButtons = new JPanel();
		// ??????????????
		pButtons.add(bthDelete);
		pButtons.add(btnFlush);
		// ?????????????????????????????—¥
		this.add(pButtons, BorderLayout.SOUTH);

		// ??????
		bthDelete.addActionListener(new ActionListener() {
			public void actionPerformed(ActionEvent e) {
				// ???????????????
				deleteData();
			}
		});
		btnFlush.addActionListener(new ActionListener() {
			public void actionPerformed(ActionEvent e) {
				// ???????????????
				showData();
			}
		});

		// ???????????????
		this.showData();

		// ?Ú…?????§³
		this.setSize(500, 400);
		// ?Ú…?????????????X??200?????Y??100?????
		this.setLocation(200, 100);
		// ?Ú…?????????????????¨®???
		this.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
		// ????????????????
		this.setVisible(true);
	}

	// ??userdetails??????????????
	private void showData() {
		// ???userdetails??
		String sql = "select id as ID??,username as ?????,case when sex='0' then '?' when sex='1' then '??' end  as ???  from userdetails";
		// ????????
		DBUtil db = new DBUtil();
		try {
			db.getConnection();
			ResultSet rs = db.executeQuery(sql, null);
			ResultSetMetaData rsmd = rs.getMetaData();
			// ???????
			int colCount = rsmd.getColumnCount();
			// ???????
			Vector<String> title = new Vector<String>();
			// ????
			for (int i = 1; i <= colCount; i++) {
				title.add(rsmd.getColumnLabel(i));
			}
			// ???????
			Vector<Vector<String>> data = new Vector<Vector<String>>();
			int rowCount = 0;
			while (rs.next()) {
				rowCount++;
				// ??????
				Vector<String> rowdata = new Vector<String>();
				for (int i = 1; i <= colCount; i++) {
					rowdata.add(rs.getString(i));
				}
				data.add(rowdata);
			}
			if (rowCount == 0) {
				model.setDataVector(null, title);
			} else {
				model.setDataVector(data, title);
			}
		} catch (Exception ee) {
			System.out.println(ee.toString());
			JOptionPane.showMessageDialog(this, "????????????????????????????????????",
					"????", 0);
		} finally {
			db.closeAll();
		}
	}

	// ???????
	public void deleteData() {
		int index[] = table.getSelectedRows();
		if (index.length == 0) {
			JOptionPane.showMessageDialog(this, "?????????????", "???",
					JOptionPane.PLAIN_MESSAGE);
		} else {
			try {
				int k = JOptionPane.showConfirmDialog(this,
						"????????????????????????????? ??", "???", JOptionPane.YES_NO_OPTION,
						JOptionPane.QUESTION_MESSAGE);
				if (k == JOptionPane.YES_OPTION) {
					DBUtil db = new DBUtil();
					try {
						db.getConnection();
						String id = table.getValueAt(index[0], 0).toString();
						String sql = "delete userdetails where id=?";
						int count = db.executeUpdate(sql, new String[] { id });
						if (count == 1) {
							JOptionPane.showMessageDialog(this, "?????????????!",
									"???", JOptionPane.PLAIN_MESSAGE);
							showData();
						} else {
							JOptionPane.showMessageDialog(this, "????? ??????????!",
									"???:", 0);
						}
					} catch (Exception e) {
						e.printStackTrace();
					} finally {
						db.closeAll();
					}
				}
			} catch (Exception ee) {
				JOptionPane.showMessageDialog(this, "???!??????????!??????????", "???:",
						0);
			}
		}
	}

	public static void main(String[] args) {
		new JTableDemo();
	}
}
